<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWL War Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2.0">
    <!-- Debug info for production -->
    <script>
        console.log('CSS URL:', "{{ url_for('static', filename='style.css') }}");
        console.log('Current URL:', window.location.href);
    </script>
</head>
<body class="bg-gradient">
    <div class="container-fluid px-3 py-4">
        <!-- Clan Tag Input Section -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-8">
                <div class="clan-input-card">
                    <h5 class="input-title">
                        <i class="fas fa-search me-2"></i>Enter Clan Tag
                    </h5>
                    <form method="GET" action="/" class="clan-input-form">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control clan-tag-input" 
                                   name="clan" 
                                   placeholder="Enter clan tag (e.g., #2QG9U2GRG)" 
                                   value="{{ request.args.get('clan', '') }}"
                                   pattern="#[A-Z0-9]{8,10}"
                                   title="Clan tag must start with # followed by 8-10 uppercase letters/numbers">
                            <button class="btn btn-primary track-btn" type="submit">
                                <i class="fas fa-search me-2"></i>Track Clan
                            </button>
                        </div>
                        <small class="form-text">
                            Enter a clan tag to track their CWL war status
                        </small>
                    </form>
                </div>
            </div>
        </div>

        <!-- Header Section -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="war-header text-center">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-sword text-warning"></i>
                        CWL War Tracker
                        <i class="fas fa-shield-alt text-primary"></i>
                    </h1>

                    {% if error %}
                        <div class="alert alert-danger shadow-lg">
                            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                        </div>
                    {% elif clan_name %}
                        <div class="war-info-card">
                            <div class="clan-vs-section">
                                <div class="clan-name">
                                    <i class="fas fa-flag text-success"></i>
                                    {{ clan_name }}
                                </div>
                                <div class="vs-divider">
                                    <span class="vs-text">VS</span>
                                </div>
                                <div class="enemy-name">
                                    <i class="fas fa-flag text-danger"></i>
                                    {{ enemy_name }}
                                </div>
                            </div>

                            <div class="war-timer mt-3">
                                <div class="timer-info">
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    <span class="fw-bold">War Ends:</span>
                                    <span class="text-info">{{ war_end_time }}</span>
                                </div>
                                <div class="time-remaining">
                                    <i class="fas fa-hourglass-half text-primary me-2"></i>
                                    <span class="fw-bold">{{ time_remaining }}</span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Dropdown Controls -->
        {% if not error and clan_name %}
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="dropdown-controls">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="dropdown-card our-clan">
                                <h5 class="dropdown-title">
                                    <i class="fas fa-users text-success me-2"></i>
                                    {{ clan_name }} Options
                                </h5>
                                <select class="form-select dropdown-select" id="ourClanDropdown" onchange="showOurClanData()">
                                    <option value="attacks" selected>Attacks Remaining</option>
                                    <option value="fresh">Bases Remaining (Fresh Bases)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="dropdown-card enemy-clan">
                                <h5 class="dropdown-title">
                                    <i class="fas fa-users text-danger me-2"></i>
                                    {{ enemy_name }} Options
                                </h5>
                                <select class="form-select dropdown-select" id="enemyClanDropdown" onchange="showEnemyClanData()">
                                    <option value="attacks" selected>Attacks Remaining</option>
                                    <option value="fresh">Bases Remaining (Fresh Bases)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Display Section -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="row g-4">
                    <!-- Our Clan Data -->
                    <div class="col-md-6">
                        <div class="data-card" id="ourClanData" style="display: none;">
                            <div class="card-header">
                                <h5 id="ourClanTitle"></h5>
                            </div>
                            <div class="card-body" id="ourClanContent">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Enemy Clan Data -->
                    <div class="col-md-6">
                        <div class="data-card" id="enemyClanData" style="display: none;">
                            <div class="card-header">
                                <h5 id="enemyClanTitle"></h5>
                            </div>
                            <div class="card-body" id="enemyClanContent">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Hidden data for JavaScript -->
    <script type="application/json" id="warData">
        {
            "clanName": "{{ clan_name }}",
            "enemyName": "{{ enemy_name }}",
            "untouchedUs": [
                {% for member in untouched_us %}
                {
                    "name": "{{ member.name }}",
                    "mapPosition": {{ member.map_position }},
                    "townHall": {{ member.town_hall }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            "untouchedEnemy": [
                {% for member in untouched_enemy %}
                {
                    "name": "{{ member.name }}",
                    "mapPosition": {{ member.map_position }},
                    "townHall": {{ member.town_hall }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            "attackersUs": [
                {% for name, left, pos, th in attackers_us %}
                {
                    "name": "{{ name }}",
                    "attacksLeft": {{ left }},
                    "mapPosition": {{ pos }},
                    "townHall": {{ th }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            "attackersEnemy": [
                {% for name, left, pos, th in attackers_enemy %}
                {
                    "name": "{{ name }}",
                    "attacksLeft": {{ left }},
                    "mapPosition": {{ pos }},
                    "townHall": {{ th }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const warData = JSON.parse(document.getElementById('warData').textContent);

        function getTownHallIcon(level) {
            return `<img src="{{ url_for('static', filename='town_hall/Building_HV_Town_Hall_level_') }}${level}.png"
                         alt="TH${level}" class="th-icon" onerror="this.style.display='none'">`;
        }

        function showOurClanData() {
            const dropdown = document.getElementById('ourClanDropdown');
            const dataCard = document.getElementById('ourClanData');
            const title = document.getElementById('ourClanTitle');
            const content = document.getElementById('ourClanContent');

            dataCard.style.display = 'block';

            if (dropdown.value === 'attacks') {
                title.innerHTML = `<i class="fas fa-sword text-warning me-2"></i>Attacks Remaining - ${warData.clanName}`;
                if (warData.attackersUs.length === 0) {
                    content.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>All attacks used!</div>';
                } else {
                    content.innerHTML = warData.attackersUs.map((attacker, index) =>
                        `<div class="player-item attacks-left">
                            ${getTownHallIcon(attacker.townHall)}
                            <div class="player-info">
                                <div class="player-name">${attacker.name}</div>
                                <div class="player-details">Base #${attacker.mapPosition} • ${attacker.attacksLeft} attack(s) left</div>
                            </div>
                            <div class="player-badge">${attacker.attacksLeft}</div>
                        </div>`
                    ).join('');
                }
            } else if (dropdown.value === 'fresh') {
                title.innerHTML = `<i class="fas fa-shield-alt text-success me-2"></i>Bases Remaining (Fresh Bases) - ${warData.clanName}`;
                if (warData.untouchedUs.length === 0) {
                    content.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>All bases have been attacked!</div>';
                } else {
                    content.innerHTML = warData.untouchedUs.map((member, index) =>
                        `<div class="player-item fresh-base">
                            ${getTownHallIcon(member.townHall)}
                            <div class="player-info">
                                <div class="player-name">${member.name}</div>
                                <div class="player-details">Base #${member.mapPosition}</div>
                            </div>
                            <div class="player-badge fresh">FRESH</div>
                        </div>`
                    ).join('');
                }
            }
        }

        function showEnemyClanData() {
            const dropdown = document.getElementById('enemyClanDropdown');
            const dataCard = document.getElementById('enemyClanData');
            const title = document.getElementById('enemyClanTitle');
            const content = document.getElementById('enemyClanContent');

            dataCard.style.display = 'block';

            if (dropdown.value === 'attacks') {
                title.innerHTML = `<i class="fas fa-sword text-warning me-2"></i>Attacks Remaining - ${warData.enemyName}`;
                if (warData.attackersEnemy.length === 0) {
                    content.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>All attacks used!</div>';
                } else {
                    content.innerHTML = warData.attackersEnemy.map((attacker, index) =>
                        `<div class="player-item attacks-left">
                            ${getTownHallIcon(attacker.townHall)}
                            <div class="player-info">
                                <div class="player-name">${attacker.name}</div>
                                <div class="player-details">Base #${attacker.mapPosition} • ${attacker.attacksLeft} attack(s) left</div>
                            </div>
                            <div class="player-badge">${attacker.attacksLeft}</div>
                        </div>`
                    ).join('');
                }
            } else if (dropdown.value === 'fresh') {
                title.innerHTML = `<i class="fas fa-shield-alt text-success me-2"></i>Bases Remaining (Fresh Bases) - ${warData.enemyName}`;
                if (warData.untouchedEnemy.length === 0) {
                    content.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>All bases have been attacked!</div>';
                } else {
                    content.innerHTML = warData.untouchedEnemy.map((member, index) =>
                        `<div class="player-item fresh-base">
                            ${getTownHallIcon(member.townHall)}
                            <div class="player-info">
                                <div class="player-name">${member.name}</div>
                                <div class="player-details">Base #${member.mapPosition}</div>
                            </div>
                            <div class="player-badge fresh">FRESH</div>
                        </div>`
                    ).join('');
                }
            }
        }

        // Auto-load attacks remaining data on page load
        window.onload = function() {
            if (warData.clanName) {
                showOurClanData();
                showEnemyClanData();
            }
        };
    </script>
</body>
</html>
